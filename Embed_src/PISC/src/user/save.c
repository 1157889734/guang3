//&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&参数保存&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
//*文件名称:save.c

//*文件作用:参数保存

//*文件作者:翟  鹏

//*创建日期:2004年5月
//&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&



#include "include.h"




//参数保存数据结构
saveparam_t saveparam;


//默认参数
static saveparam_t const defaultparam=
{	
	0x11223344,//版本号

	//终点站提示语播放列表
	{	
		{0,0,0,0,0},  // 1  罗湖
		{0,0,0,0,0},  // 2  国贸
		{0,0,0,0,0},  // 3  老街
		{0,0,0,0,0},  // 4  大剧院
		{0,0,0,0,0},  // 5  科学馆
		{0,0,0,0,0},  // 6  华强路
		{0,0,0,0,0},  // 7  岗厦
		{0,0,0,0,0},  // 8  会展中心
		{0,0,0,0,0},  // 9  购物公园
		{0,0,0,0,0},  // 10  香蜜湖
		{0,0,0,0,0},  // 11  车公庙
		{0,0,0,0,0},  // 12  竹子林
		{0,0,0,0,0},  // 13  侨城东
		{0,0,0,0,0},  // 14  华侨城
		{0,0,0,0,0},  // 15  世界之窗
		{0,0,0,0,0},  // 16  白石洲
		{0,0,0,0,0},  // 17  高新园
		{0,0,0,0,0},  // 18  深大
		{0,0,0,0,0},  // 19  桃园
		{0,0,0,0,0},  // 20  大新
		{0,0,0,0,0},  // 21  鲤鱼门
		{0,0,0,0,0},  // 22  前海湾
		{0,0,0,0,0},  // 23  新安
		{0,0,0,0,0},  // 24  宝安中心
		{0,0,0,0,0},  // 25  宝体
		{0,0,0,0,0},  // 26  坪洲
		{0x50,0x12,0x45,0x02,0},  // 27  西乡 [5,7,10,13,17,19,23,26]
		{0,0,0,0,0},  // 28  固戍
		{0,0,0,0,0},  // 29  后瑞
		{0,0,0,0,0},  // 30  机场东
	},

    //for test hk
	//令牌巡检表
	{0x11,0x21,0x63,0X12,0x23,0x53,0x43,0x33,0x22,0x13,0x17,0x27,0x0, 0,},
	{200,  200,  200,  200,  200, 200,  200,  200,  200, 200, 26000, 26000,  0,  0,  },
   //end for test hk
	
	//站的代码表
	#if 1
	{13,11,9,5,3,1,46,43,41,39,33,31,29,65,63,61,58,55,53,51,80,78,76,72,68,   26,24,22,20,17,0,}, //North	
	{14,12,10,7,4,2,47,44,42,40,35,32,30,66,64,62,60,56,54,52,81,79,77,74,70,  27,25,23,21,19,0,},//South,
	
	//{0x13,0x11,0x09,0x05,0x03,0x01,0x46,0x43,0x41,0x39,0x33,0x31,0x29,0x65,0x63,0x61,0x58,0x55,0x53,0x51,0x80,0x78,0x76,0x72,0x68,   0x26,0x24,0x22,0x20,0x17,0x00,}, //North
	//{0x14,0x12,0x10,0x07,0x04,0x02,0x47,0x44,0x42,0x40,0x35,0x32,0x30,0x66,0x64,0x62,0x60,0x56,0x54,0x52,0x81,0x79,0x77,0x74,0x70,  0x27,0x25,0x23,0x21,0x19,0x00,},//South,
	 #endif
	STATION_TOTAL_NUM,//站总数
	
	150,//左右门触发指示
	
	//开门侧指示
	{2,2,2,2,2, 2,2,2,2,2, 2,2,2,2,2, 2,2,2,2,2, 2,2,2,1,1, 2,2,2,2,1, 2,2,2,2,2,2,1,0},
	{2,2,2,2,2, 2,2,2,2,2, 2,2,2,2,2, 2,2,2,2,2, 2,2,2,1,1, 2,2,2,2,1, 2,2,2,2,2,2,1,0},
	
	//离站广播触发距离
	{300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,0}, 

   //到站广播触发距离
   {300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,300,0}, 


	//两站之间距离
	{
		{2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,0},   //第一条线
		{2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,0}, 
		{2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,2000,0}, 
	},

	//预报站触发延时时间
	{
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
		40000,
	},

	//站名
	{
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0,0},
		{0,0},
		{0,0},
		{0,0},
		{0,0},
	},

	//关门提示音
	{230,0},	
	//关门提示播放次数
	0x01, 
	//特殊广播次数
	{0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,0},
	//广播优先级:OCC  乘客紧急对讲 司机对讲 人工广播 关门提示音 DVA MEDIA 紧急广播 测试语音
	//{7,5,5,6,3,2,1,4},
	{6,7,9,8,5,3,1,4,2},
	0x2e,//总音量
	0x3f,//通道1音量
	0x35,//0x3f,//通道2音量
	0x3f,//通道3音量
	0x3f,//关门提示音 音量
	0x10,//重低音
	0x10,//高音
	0x1e,//总音量百分比
	0x64,//通道1音量百分比
	0x64,//通道2音量百分比
	0x64,//通道3音量百分比
	0x64,//关门提示音 音量百分比
	0x03,//重低音百分比
	0x03,//高音百分比
	0,//是否同时媒体播放
	1,//是否播放关门提示音

	0x0b, // 广播监听音量
	0x0d,// 司机对讲监听音量
	0x0d, // 乘客对讲监听音量
	0x0d,// 广播麦克音量
	0x0d,// 司机对讲麦克音量
	0x0d,// 乘客对讲麦克音量
		
	0xff,//MODE_PRESET<<4|VOLUME_80DB,//客室功放参数

	0x00000000,//异常数据存储的地址
	0,
	{0},//上一次存储的信息  2010-9-9
	//校验和
	0,
};



//保存任务标志
static uint8 save_task=0;
//备份flash擦除任务标志
static uint16 save_erase_timer=0;
//程序更新标志
static uint16 save_update_timer=0;



//***********************************************************************************************************************
//函数作用:保存参数
//参数说明:
//注意事项:
//返回说明:保存成功返回1
//***********************************************************************************************************************
static void save_param(void)
{
	uint32 i;
   	uint8 sum=0;
	uint8 *p=(uint8 *)&saveparam;

	//计算校验和
	for(i=0;i<sizeof(saveparam_t)-1;i++)sum+=p[i];
	p[i]=0x55-sum;
		
	//擦除flash
	flash_erase(PARAM_ADDR,sizeof(saveparam_t));
	//写入flash
	flash_write((uint8 *)&saveparam,PARAM_ADDR,sizeof(saveparam_t));
}

//***********************************************************************************************************************
//函数作用:保存参数处理
//参数说明:
//注意事项:
//返回说明:
//***********************************************************************************************************************
void save_proc(void)
{
	//保存参数
	if(save_task)
	{
		save_task = 0;
		save_param();
	}
	
	//擦除备份FLASH
	if(save_erase_timer)
	{
		if(--save_erase_timer == 0)
		{
			//备份FLASH
			flash_erase(FLASH_BACKUP_BASE,FLASH_BACKUP_LENGTH);	
		}	
	}
	
	//更新程序
	if(save_update_timer)
	{
		if(--save_update_timer==0)
		{
			//擦除参数区域
			flash_erase(PARAM_ADDR,sizeof(saveparam_t));
			//进行程序搬移---从备份flash拷贝到运行flash 拷贝完毕利用看门狗复位
			flash_copy(FLASH_BACKUP_LENGTH);			
		}	
	}
}

//***********************************************************************************************************************
//函数作用:保存参数设置任务
//参数说明:
//注意事项:
//返回说明:保存成功返回1
//***********************************************************************************************************************
void save_set_task(void)
{
	save_task=1;
}

//***********************************************************************************************************************
//函数作用:保存参数设置擦除备份flash
//参数说明:
//注意事项:
//返回说明:保存成功返回1
//***********************************************************************************************************************
void save_set_erase(void)
{
	save_erase_timer=30000;
}

//***********************************************************************************************************************
//函数作用:保存参数设置程序更新任务
//参数说明:
//注意事项:
//返回说明:保存成功返回1
//***********************************************************************************************************************
void save_set_update(void)
{
	save_update_timer=60000;
}

//***********************************************************************************************************************
//函数作用:装载缺省
//参数说明:
//注意事项:
//返回说明:成功返回1
//***********************************************************************************************************************
void save_load_default(void)
{
	uint32 i;
	uint8 *p=(uint8 *)&saveparam;
	uint8 const *p_default=(uint8 const *)&defaultparam;
	
	for(i=0;i<sizeof(saveparam_t);i++)p[i]=p_default[i];
}

//***********************************************************************************************************************
//函数作用:参数初始化
//参数说明:
//注意事项:
//返回说明:成功返回1
//***********************************************************************************************************************
void save_init(void)
{
	uint32 i;
	uint8 sum=0;
	uint8 *p=(uint8 *)&saveparam;
	
	//从flash中装载数据
	memcpy((uint8 *)&saveparam,(uint8 *)PARAM_ADDR,sizeof(saveparam_t));
	//核对校验和
	for(i=0; i<sizeof(saveparam_t); i++)
		sum+=p[i];
	//校验和正确
	if(0x55 == sum)
	{
		//print_line("param ok");
	}
	else
	{
		//校验和错误 装载缺省
		save_load_default();
		//print_line("load default");
	}
}


