//&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&定时器1驱动程序&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&
//*文件名称:timer1.c

//*文件作用:定时器1驱动程序

//*文件作者:翟  鹏

//*创建日期:2007年5月
//&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&&



#include "include.h"



static uint16 timer1_ms=0;//记忆定时器周期

//中断处理钩子
static void(*timer1_hook)(void)=NULL;


//***********************************************************************************************************************
//函数作用:定时器1中断服务程序
//参数说明:
//注意事项:
//返回说明:无
//***********************************************************************************************************************
void T1TIMI_IRQHandler(void)
{
	//清除中断标志
	TIM1_SR&=(~0x2000);
	//调用钩子
	if(timer1_hook)timer1_hook();
}

//***********************************************************************************************************************
//函数作用:定时器1初始化---设置周期和中断钩子
//参数说明:
//注意事项:
//返回说明:无
//***********************************************************************************************************************
void timer1_init(uint16 ms)
{
	//注册中断
	//TIMER1_IRQ_SLOT=(uint32)TIMER1_HANDLER;//设置中断处理句柄地址---在IRQ.S中已经完成
	TIMER1_IRQ_SLOT=(TIMER1_IRQ_SLOT&0xFFFF0000)|TIMER1_IRQ_PRIORITY;//设置优先级--最高15
	EIC_IER|=1<<TIMER1_IRQ_VECTOR;//使能中断控制器相应的槽

	//设置寄存器
	TIM1_CR1=0x0000;
	TIM1_CR2=0x0000;
	TIM1_SR=0x0000;
	TIM1_CR2=(TIM1_CR2&0xFF00)|((Fcclk*ms/1000/65536)-1);//设置分频系数
	timer1_ms=ms;//记忆定时器频率
	TIM1_CR1|=0x8000;//开定时器
	//开中断
	TIM1_CR2|=0x2000;
}

//***********************************************************************************************************************
//函数作用:定时器1中断开关
//参数说明:
//注意事项:
//返回说明:无
//***********************************************************************************************************************
void timer1_onoff(uint8 onoff)
{
	//开中断
	if(onoff)TIM1_CR2|=0x2000;
	//关闭中断
	else TIM1_CR2&=~0x2000;	
}

//***********************************************************************************************************************
//函数作用:定时器1设置钩子函数
//参数说明:
//注意事项:
//返回说明:无
//***********************************************************************************************************************
void timer1_set_hook(void(*hook)(void))
{
	timer1_hook=hook;
}


